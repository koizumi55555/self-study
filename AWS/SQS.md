# AWS SQS

#### アプリケーションの通信(前提)

- 同期通信
  - AppとAppの間
- 非同期通信
  - イベントベース(App - キュー - App)

App間でトラフィックが急激に上昇する際の解決法
- SQS：キューモデル
- SNS：Pub/Subモデル
- Kinesis：リアルタイム・ストリーミング・モデル

## 概要
- AWSで最も古いサービス
- フルマネージドサービス
- Appのデカップリングに使用

- 特徴
  - 無制限のスループット、無制限のキュー内のメッセージ数
  - メッセージの保存期間はデフォルトでは保存期間は4日間、最大でも14日
  - 低レイテンシー
  - 一つのメッセージのデータサイズは256KBまで

- 重複したメッセージが発生する可能性がある
- ススタンダード級ではメッセージの順序付けはされていない


## メッセージの送信
- SDK(sendMessageAPI)を利用してSQSに送信
- メッセージはコンシューマーが削除するまでSQESに保存
- メッセージの保存期間はデフォルトでは保存期間は4日間、最大でも14日
- 無制限のスループット

## メッセージの消費(Consume)
- コンシューマ(EC2インスタンスやサーバー、Lambda)
- SQSのメッセージをポーリング(1度に最大10件まで受診可能)
- メッセージを処理
- DeleteMessageAPIを使用してメッセージを削除
- 複数のコンシューマにも対応

## セキュリティ
- 暗号化
  - HTTP APIによる通信路の暗号化
  - KMSキーを使ったデータの暗号化
  - クライアントサイドの暗号化
- アクセスコントロール：SQS APIへのアクセスを規制するIAMポリシー
- SQSアクセスポリシー
  - SQSキューへの別アカウントからのアクセス許可

## SQSキューへのアクセスポリシー
- クロスアカウントアクセス
  - アクセスポリシーに別アカウントのIDを記載することにより許可可能

## メッセージ可視性タイムアウト
- コンシューマーによってポーリングされた後、他のコンシューマーからは見えなくなる
- デフォルトでは、メッセージ可視化タイムアウトは30秒
- メッセージ可視化のタイムアウトした後、再びメッセージはSQSで可視状態になる
- 削除されていなければそのメッセージも対象として返される(2回目処理される)
- ChengeMessageVisibilityAPIで延長可能

## Dead Letter Queue
- コンシューマが可視性タイムアウト内にメッセージの処理ができなかった場合、そのメッセージはキューに戻る
- メッセージが何回キューに戻るか閾値を設定可能
- 最大受診数の閾値を超えると、メッセージはDLQに入る。

## 遅延キュー
- メッセージを一定時間(最大15分)延長可能
- デフォルトは0秒
- キューレベルでのデフォルト設定可能
- 送信時のDelaySeconds パラメータで、送信時のデフォルトを上書き可

## FIFOキュー
- キュー内のメッセージの順番を必ず保つ